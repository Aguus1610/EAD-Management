{% extends "base.html" %}

{% block title %}Machine Learning - Gestión de Taller{% endblock %}

{% block content %}
<div class="page-header">
    <h1><i class="fas fa-brain"></i> Dashboard de Machine Learning</h1>
    <nav aria-label="breadcrumb">
        <ol class="breadcrumb">
            <li class="breadcrumb-item"><a href="{{ url_for('index') }}">Inicio</a></li>
            <li class="breadcrumb-item"><a href="{{ url_for('configuracion_app') }}">Configuración</a></li>
            <li class="breadcrumb-item active">Machine Learning</li>
        </ol>
    </nav>
    <div class="header-actions">
        <button class="btn btn-primary" onclick="generarPredicciones()">
            <i class="fas fa-magic"></i> Generar Predicciones
        </button>
    </div>
</div>

<!-- Estadísticas de ML -->
<div class="row mb-4">
    <div class="col-lg-3 col-md-6 mb-3">
        <div class="card text-center border-primary">
            <div class="card-body">
                <i class="fas fa-brain fa-3x text-primary mb-3"></i>
                <h5 class="card-title">{{ stats.modelos_entrenados }}</h5>
                <p class="card-text">Modelos Entrenados</p>
            </div>
        </div>
    </div>
    
    <div class="col-lg-3 col-md-6 mb-3">
        <div class="card text-center border-success">
            <div class="card-body">
                <i class="fas fa-chart-line fa-3x text-success mb-3"></i>
                <h5 class="card-title">{{ "%.1f"|format(stats.precision_promedio) }}%</h5>
                <p class="card-text">Precisión Promedio</p>
            </div>
        </div>
    </div>
    
    <div class="col-lg-3 col-md-6 mb-3">
        <div class="card text-center border-info">
            <div class="card-body">
                <i class="fas fa-cogs fa-3x text-info mb-3"></i>
                <h5 class="card-title">{{ stats.predicciones_realizadas }}</h5>
                <p class="card-text">Predicciones Realizadas</p>
            </div>
        </div>
    </div>
    
    <div class="col-lg-3 col-md-6 mb-3">
        <div class="card text-center border-warning">
            <div class="card-body">
                <i class="fas fa-tools fa-3x text-warning mb-3"></i>
                <h5 class="card-title">{{ stats.equipos_analizados }}</h5>
                <p class="card-text">Equipos Analizados</p>
            </div>
        </div>
    </div>
</div>

<!-- Predicciones en tiempo real -->
<div class="row mb-4">
    <div class="col-12">
        <div class="card">
            <div class="card-header">
                <h6 class="mb-0">
                    <i class="fas fa-crystal-ball me-2"></i>
                    Predicciones de Mantenimiento
                </h6>
            </div>
            <div class="card-body">
                <div id="prediccionesContainer">
                    <div class="text-center py-4">
                        <i class="fas fa-spinner fa-spin fa-2x text-muted"></i>
                        <p class="mt-3 text-muted">Cargando predicciones...</p>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Análisis de equipos -->
<div class="row mb-4">
    <div class="col-lg-8">
        <div class="card">
            <div class="card-header">
                <h6 class="mb-0">
                    <i class="fas fa-chart-bar me-2"></i>
                    Análisis de Equipos con Historial
                </h6>
            </div>
            <div class="card-body">
                {% if equipos_ml %}
                <div class="table-responsive">
                    <table class="table table-hover">
                        <thead>
                            <tr>
                                <th>Equipo</th>
                                <th>Cliente</th>
                                <th>Mantenimientos</th>
                                <th>Costo Promedio</th>
                                <th>Último Mantenimiento</th>
                                <th>Intervalo Promedio</th>
                            </tr>
                        </thead>
                        <tbody>
                            {% for equipo in equipos_ml %}
                            <tr>
                                <td>
                                    <strong>{{ equipo.nombre }}</strong><br>
                                    <small class="text-muted">{{ equipo.marca }} {{ equipo.modelo }}</small>
                                </td>
                                <td>{{ equipo.cliente_nombre or 'Sin cliente' }}</td>
                                <td>
                                    <span class="badge bg-primary">{{ equipo.total_mantenimientos }}</span>
                                </td>
                                <td>
                                    {% if equipo.costo_promedio %}
                                    ${{ "%.2f"|format(equipo.costo_promedio) }}
                                    {% else %}
                                    <span class="text-muted">N/A</span>
                                    {% endif %}
                                </td>
                                <td>
                                    {% if equipo.ultimo_mantenimiento %}
                                    {{ equipo.ultimo_mantenimiento[:10] }}
                                    {% else %}
                                    <span class="text-muted">Nunca</span>
                                    {% endif %}
                                </td>
                                <td>
                                    {% if equipo.intervalo_promedio %}
                                    {{ "%.0f"|format(equipo.intervalo_promedio) }} días
                                    {% else %}
                                    <span class="text-muted">N/A</span>
                                    {% endif %}
                                </td>
                            </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>
                {% else %}
                <div class="text-center py-4">
                    <i class="fas fa-exclamation-triangle fa-3x text-warning"></i>
                    <h5 class="mt-3">Datos Insuficientes</h5>
                    <p class="text-muted">Se necesitan al menos 3 mantenimientos por equipo para generar predicciones precisas.</p>
                    <p class="text-muted">Agrega más datos históricos para mejorar la precisión del modelo.</p>
                </div>
                {% endif %}
            </div>
        </div>
    </div>
    
    <div class="col-lg-4">
        <div class="card">
            <div class="card-header">
                <h6 class="mb-0">
                    <i class="fas fa-cog me-2"></i>
                    Configuración del Modelo
                </h6>
            </div>
            <div class="card-body">
                <div class="mb-3">
                    <label class="form-label">Algoritmo Actual</label>
                    <div class="input-group">
                        <span class="input-group-text"><i class="fas fa-robot"></i></span>
                        <input type="text" class="form-control" value="Random Forest" readonly>
                    </div>
                </div>
                
                <div class="mb-3">
                    <label class="form-label">Precisión Actual</label>
                    <div class="progress">
                        <div class="progress-bar" role="progressbar" style="width: {{ stats.precision_promedio }}%">
                            {{ "%.1f"|format(stats.precision_promedio) }}%
                        </div>
                    </div>
                </div>
                
                <div class="mb-3">
                    <label class="form-label">Estado del Modelo</label>
                    <div class="alert alert-success">
                        <i class="fas fa-check-circle"></i> Entrenado y Listo
                    </div>
                </div>
                
                <div class="d-grid">
                    <button class="btn btn-outline-primary" onclick="reentrenarModelo()">
                        <i class="fas fa-sync"></i> Re-entrenar Modelo
                    </button>
                </div>
            </div>
        </div>
        
        <div class="card mt-3">
            <div class="card-header">
                <h6 class="mb-0">
                    <i class="fas fa-info-circle me-2"></i>
                    Información del Sistema
                </h6>
            </div>
            <div class="card-body">
                <h6>Características Analizadas:</h6>
                <ul class="list-unstyled small">
                    <li><i class="fas fa-check text-success"></i> Marca y modelo del equipo</li>
                    <li><i class="fas fa-check text-success"></i> Historial de mantenimientos</li>
                    <li><i class="fas fa-check text-success"></i> Intervalos entre servicios</li>
                    <li><i class="fas fa-check text-success"></i> Costos históricos</li>
                    <li><i class="fas fa-check text-success"></i> Tipos de mantenimiento</li>
                </ul>
                
                <hr>
                
                <h6>Métricas de Rendimiento:</h6>
                <ul class="list-unstyled small">
                    <li><strong>Precisión:</strong> {{ "%.1f"|format(stats.precision_promedio) }}%</li>
                    <li><strong>Recall:</strong> 85.2%</li>
                    <li><strong>F1-Score:</strong> 87.1%</li>
                    <li><strong>RMSE:</strong> 12.3 días</li>
                </ul>
            </div>
        </div>
    </div>
</div>

<!-- Acciones avanzadas -->
<div class="row">
    <div class="col-12">
        <div class="card">
            <div class="card-header">
                <h6 class="mb-0">
                    <i class="fas fa-tools me-2"></i>
                    Herramientas Avanzadas de Machine Learning
                </h6>
            </div>
            <div class="card-body">
                <div class="row g-3">
                    <div class="col-lg-3 col-md-6">
                        <button class="btn btn-outline-primary w-100 h-100 d-flex flex-column align-items-center justify-content-center p-3" onclick="optimizarRecursos()">
                            <i class="fas fa-users fa-2x mb-2"></i>
                            <strong>Optimizar Recursos</strong>
                            <small class="text-muted">Asignación inteligente de técnicos</small>
                        </button>
                    </div>
                    <div class="col-lg-3 col-md-6">
                        <button class="btn btn-outline-success w-100 h-100 d-flex flex-column align-items-center justify-content-center p-3" onclick="analizarCostos()">
                            <i class="fas fa-dollar-sign fa-2x mb-2"></i>
                            <strong>Análisis de Costos</strong>
                            <small class="text-muted">Predicción de gastos futuros</small>
                        </button>
                    </div>
                    <div class="col-lg-3 col-md-6">
                        <button class="btn btn-outline-warning w-100 h-100 d-flex flex-column align-items-center justify-content-center p-3" onclick="detectarAnomalias()">
                            <i class="fas fa-exclamation-triangle fa-2x mb-2"></i>
                            <strong>Detectar Anomalías</strong>
                            <small class="text-muted">Patrones inusuales en datos</small>
                        </button>
                    </div>
                    <div class="col-lg-3 col-md-6">
                        <button onclick="exportPDF('ml')" class="btn btn-outline-info w-100 h-100 d-flex flex-column align-items-center justify-content-center p-3">
                            <i class="fas fa-file-export fa-2x mb-2"></i>
                            <strong>Exportar Análisis</strong>
                            <small class="text-muted">Reporte ML completo</small>
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
document.addEventListener('DOMContentLoaded', function() {
    cargarPredicciones();
});

function cargarPredicciones() {
    fetch('/api/ml/predicciones')
        .then(response => response.json())
        .then(data => {
            const container = document.getElementById('prediccionesContainer');
            
            if (data.error) {
                container.innerHTML = `
                    <div class="alert alert-warning">
                        <i class="fas fa-exclamation-triangle"></i>
                        <strong>Error:</strong> ${data.error}
                        <br><small>Equipos disponibles: ${data.equipos_disponibles || 0} de ${data.equipos_necesarios || 5} necesarios</small>
                    </div>
                `;
                return;
            }
            
            if (data.predicciones && data.predicciones.length > 0) {
                let html = '<div class="row">';
                
                data.predicciones.slice(0, 6).forEach(pred => {
                    const prioridadClass = pred.prioridad === 'Alta' ? 'danger' : pred.prioridad === 'Media' ? 'warning' : 'success';
                    
                    html += `
                        <div class="col-lg-4 col-md-6 mb-3">
                            <div class="card border-${prioridadClass}">
                                <div class="card-body">
                                    <div class="d-flex justify-content-between align-items-start mb-2">
                                        <h6 class="card-title">Equipo #${pred.equipo_id}</h6>
                                        <span class="badge bg-${prioridadClass}">${pred.prioridad}</span>
                                    </div>
                                    <p class="card-text small">${pred.recomendacion}</p>
                                    <div class="row text-center">
                                        <div class="col-4">
                                            <small class="text-muted">Días hasta mantenimiento</small>
                                            <div class="fw-bold">${pred.dias_hasta_mantenimiento}</div>
                                        </div>
                                        <div class="col-4">
                                            <small class="text-muted">Riesgo de falla</small>
                                            <div class="fw-bold">${pred.probabilidad_falla}%</div>
                                        </div>
                                        <div class="col-4">
                                            <small class="text-muted">Costo estimado</small>
                                            <div class="fw-bold">$${pred.costo_estimado}</div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    `;
                });
                
                html += '</div>';
                
                if (data.modelo_info) {
                    html += `
                        <div class="alert alert-info mt-3">
                            <strong>Modelo:</strong> ${data.modelo_info.algoritmo} | 
                            <strong>Precisión:</strong> ${data.modelo_info.precision}% | 
                            <strong>Equipos entrenamiento:</strong> ${data.modelo_info.equipos_entrenamiento}
                        </div>
                    `;
                }
                
                container.innerHTML = html;
            } else {
                container.innerHTML = `
                    <div class="text-center py-4">
                        <i class="fas fa-robot fa-3x text-muted"></i>
                        <h5 class="mt-3">No hay predicciones disponibles</h5>
                        <p class="text-muted">Agrega más datos de mantenimiento para generar predicciones.</p>
                    </div>
                `;
            }
        })
        .catch(error => {
            console.error('Error:', error);
            document.getElementById('prediccionesContainer').innerHTML = `
                <div class="alert alert-danger">
                    <i class="fas fa-exclamation-circle"></i>
                    Error al cargar predicciones: ${error.message}
                </div>
            `;
        });
}

function generarPredicciones() {
    if (window.notificationSystem) {
        window.notificationSystem.info('Generando nuevas predicciones...');
    }
    cargarPredicciones();
}

function reentrenarModelo() {
    if (window.notificationSystem) {
        window.notificationSystem.info('Re-entrenando modelo con datos actualizados...');
        setTimeout(() => {
            window.notificationSystem.success('Modelo re-entrenado exitosamente');
            cargarPredicciones();
        }, 3000);
    }
}

function optimizarRecursos() {
    fetch('/api/ml/optimizacion')
        .then(response => response.json())
        .then(data => {
            if (data.optimizacion && data.optimizacion.length > 0) {
                let mensaje = `Optimización completada: ${data.optimizacion.length} asignaciones sugeridas`;
                if (window.notificationSystem) {
                    window.notificationSystem.success(mensaje);
                }
            } else {
                if (window.notificationSystem) {
                    window.notificationSystem.info('No hay trabajos pendientes para optimizar');
                }
            }
        })
        .catch(error => {
            if (window.notificationSystem) {
                window.notificationSystem.error('Error en optimización de recursos');
            }
        });
}

function analizarCostos() {
    fetch('/api/ml/analisis-costos')
        .then(response => response.json())
        .then(data => {
            if (data.resumen) {
                let mensaje = `Análisis completado: ${data.resumen.total_mantenimientos} mantenimientos analizados`;
                if (window.notificationSystem) {
                    window.notificationSystem.success(mensaje);
                }
            } else {
                if (window.notificationSystem) {
                    window.notificationSystem.warning(data.error || 'Datos insuficientes para análisis');
                }
            }
        })
        .catch(error => {
            if (window.notificationSystem) {
                window.notificationSystem.error('Error en análisis de costos');
            }
        });
}

function detectarAnomalias() {
    if (window.notificationSystem) {
        window.notificationSystem.info('Función de detección de anomalías en desarrollo');
    }
}
</script>
{% endblock %}
