{% extends "base.html" %}

{% block title %}{{ cliente.nombre }} - Detalles del Cliente{% endblock %}

{% block content %}
<div class="container-fluid">
    <div class="row">
        <div class="col-12">
            <div class="d-flex justify-content-between align-items-center mb-4">
                <h1><i class="fas fa-user"></i> {{ cliente.nombre }}</h1>
                <div>
                    <a href="{{ url_for('editar_cliente', id=cliente.id) }}" class="btn btn-warning">
                        <i class="fas fa-edit"></i> Editar
                    </a>
                    <a href="{{ url_for('clientes') }}" class="btn btn-secondary">
                        <i class="fas fa-arrow-left"></i> Volver
                    </a>
                </div>
            </div>

            <!-- Información del Cliente -->
            <div class="row">
                <div class="col-md-6">
                    <div class="card">
                        <div class="card-header">
                            <h5 class="card-title mb-0">
                                <i class="fas fa-info-circle"></i> Información del Cliente
                            </h5>
                        </div>
                        <div class="card-body">
                            <table class="table table-borderless">
                                <tr>
                                    <td><strong><i class="fas fa-user"></i> Nombre:</strong></td>
                                    <td>{{ cliente.nombre }}</td>
                                </tr>
                                {% if cliente.telefono %}
                                <tr>
                                    <td><strong><i class="fas fa-phone"></i> Teléfono:</strong></td>
                                    <td>{{ cliente.telefono }}</td>
                                </tr>
                                {% endif %}
                                {% if cliente.email %}
                                <tr>
                                    <td><strong><i class="fas fa-envelope"></i> Email:</strong></td>
                                    <td>{{ cliente.email }}</td>
                                </tr>
                                {% endif %}
                                {% if cliente.direccion %}
                                <tr>
                                    <td><strong><i class="fas fa-map-marker-alt"></i> Dirección:</strong></td>
                                    <td>{{ cliente.direccion }}</td>
                                </tr>
                                {% endif %}
                                <tr>
                                    <td><strong><i class="fas fa-calendar"></i> Cliente desde:</strong></td>
                                    <td>{{ cliente.fecha_creacion }}</td>
                                </tr>
                            </table>
                            {% if cliente.observaciones %}
                            <div class="mt-3">
                                <strong><i class="fas fa-sticky-note"></i> Observaciones:</strong>
                                <p class="mt-2">{{ cliente.observaciones }}</p>
                            </div>
                            {% endif %}
                        </div>
                    </div>
                </div>
                <div class="col-md-6">
                    <div class="card">
                        <div class="card-header">
                            <h5 class="card-title mb-0">
                                <i class="fas fa-chart-bar"></i> Estadísticas
                            </h5>
                        </div>
                        <div class="card-body">
                            <div class="row text-center">
                                <div class="col-6">
                                    <div class="border rounded p-3">
                                        <h3 class="text-primary">{{ equipos|length }}</h3>
                                        <small class="text-muted">Equipos</small>
                                    </div>
                                </div>
                                <div class="col-6">
                                    <div class="border rounded p-3">
                                        <h3 class="text-success">{{ mantenimientos|length }}+</h3>
                                        <small class="text-muted">Mantenimientos</small>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Equipos del Cliente -->
            <div class="card mt-4">
                <div class="card-header d-flex justify-content-between align-items-center">
                    <h5 class="card-title mb-0">
                        <i class="fas fa-cogs"></i> Equipos ({{ equipos|length }})
                    </h5>
                    <a href="{{ url_for('nuevo_equipo') }}?cliente_id={{ cliente.id }}" class="btn btn-success btn-sm">
                        <i class="fas fa-plus"></i> Agregar Equipo
                    </a>
                </div>
                <div class="card-body">
                    {% if equipos %}
                    <div class="table-responsive">
                        <table class="table table-hover" id="equiposTable">
                            <thead>
                                <tr>
                                    <th class="sortable" data-column="nombre">
                                        <i class="fas fa-sort"></i> Nombre
                                    </th>
                                    <th class="sortable" data-column="marca">
                                        <i class="fas fa-sort"></i> Marca
                                    </th>
                                    <th class="sortable" data-column="modelo">
                                        <i class="fas fa-sort"></i> Modelo
                                    </th>
                                    <th class="sortable" data-column="estado">
                                        <i class="fas fa-sort"></i> Estado
                                    </th>
                                    <th>Acciones</th>
                                </tr>
                            </thead>
                            <tbody>
                                {% for equipo in equipos %}
                                <tr>
                                    <td>{{ equipo.nombre }}</td>
                                    <td>{{ equipo.marca or '-' }}</td>
                                    <td>{{ equipo.modelo or '-' }}</td>
                                    <td>
                                        {% if equipo.estado == 'Activo' %}
                                            <span class="badge bg-success">Activo</span>
                                        {% elif equipo.estado == 'Mantenimiento' %}
                                            <span class="badge bg-warning">Mantenimiento</span>
                                        {% else %}
                                            <span class="badge bg-secondary">{{ equipo.estado }}</span>
                                        {% endif %}
                                    </td>
                                    <td>
                                        <a href="{{ url_for('editar_equipo', id=equipo.id) }}" class="btn btn-sm btn-warning">
                                            <i class="fas fa-edit"></i>
                                        </a>
                                    </td>
                                </tr>
                                {% endfor %}
                            </tbody>
                        </table>
                    </div>
                    {% else %}
                    <div class="text-center py-4">
                        <i class="fas fa-cogs fa-3x text-muted mb-3"></i>
                        <p class="text-muted">Este cliente no tiene equipos registrados.</p>
                        <a href="{{ url_for('nuevo_equipo') }}?cliente_id={{ cliente.id }}" class="btn btn-success">
                            <i class="fas fa-plus"></i> Agregar Primer Equipo
                        </a>
                    </div>
                    {% endif %}
                </div>
            </div>

            <!-- Mantenimientos Recientes -->
            <div class="card mt-4">
                <div class="card-header d-flex justify-content-between align-items-center">
                    <h5 class="card-title mb-0">
                        <i class="fas fa-wrench"></i> Mantenimientos Recientes (últimos 10)
                    </h5>
                    <a href="{{ url_for('nuevo_mantenimiento') }}?cliente_id={{ cliente.id }}" class="btn btn-success btn-sm">
                        <i class="fas fa-plus"></i> Agregar Mantenimiento
                    </a>
                </div>
                <div class="card-body">
                    {% if mantenimientos %}
                    <div class="table-responsive">
                        <table class="table table-hover" id="mantenimientosTable">
                            <thead>
                                <tr>
                                    <th class="sortable" data-column="fecha_mantenimiento">
                                        <i class="fas fa-sort"></i> Fecha
                                    </th>
                                    <th class="sortable" data-column="equipo_nombre">
                                        <i class="fas fa-sort"></i> Equipo
                                    </th>
                                    <th class="sortable" data-column="tipo_mantenimiento">
                                        <i class="fas fa-sort"></i> Tipo
                                    </th>
                                    <th>Descripción</th>
                                </tr>
                            </thead>
                            <tbody>
                                {% for mant in mantenimientos %}
                                <tr>
                                    <td>{{ mant.fecha_mantenimiento }}</td>
                                    <td>{{ mant.equipo_nombre }}</td>
                                    <td>
                                        {% if mant.tipo_mantenimiento == 'Preventivo' %}
                                            <span class="badge bg-info">Preventivo</span>
                                        {% elif mant.tipo_mantenimiento == 'Correctivo' %}
                                            <span class="badge bg-warning">Correctivo</span>
                                        {% else %}
                                            <span class="badge bg-secondary">{{ mant.tipo_mantenimiento }}</span>
                                        {% endif %}
                                    </td>
                                    <td>{{ mant.descripcion[:80] }}{% if mant.descripcion|length > 80 %}...{% endif %}</td>
                                </tr>
                                {% endfor %}
                            </tbody>
                        </table>
                    </div>
                    {% else %}
                    <div class="text-center py-4">
                        <i class="fas fa-wrench fa-3x text-muted mb-3"></i>
                        <p class="text-muted">Este cliente no tiene mantenimientos registrados.</p>
                        <a href="{{ url_for('nuevo_mantenimiento') }}?cliente_id={{ cliente.id }}" class="btn btn-success">
                            <i class="fas fa-plus"></i> Agregar Primer Mantenimiento
                        </a>
                    </div>
                    {% endif %}
                </div>
            </div>
        </div>
    </div>
</div>

<script>
// Funcionalidad de ordenamiento por columnas
document.querySelectorAll('.sortable').forEach(header => {
    header.style.cursor = 'pointer';
    header.addEventListener('click', function() {
        const table = this.closest('table');
        const column = this.dataset.column;
        sortTable(table, column);
    });
});

function sortTable(table, column) {
    const tbody = table.querySelector('tbody');
    const rows = Array.from(tbody.querySelectorAll('tr'));
    const isAscending = table.dataset.sortOrder !== 'asc';
    
    rows.sort((a, b) => {
        const aValue = getCellValue(a, column);
        const bValue = getCellValue(b, column);
        
        if (isAscending) {
            return aValue.localeCompare(bValue, undefined, {numeric: true});
        } else {
            return bValue.localeCompare(aValue, undefined, {numeric: true});
        }
    });
    
    // Actualizar el DOM
    rows.forEach(row => tbody.appendChild(row));
    
    // Actualizar el estado de ordenamiento
    table.dataset.sortOrder = isAscending ? 'asc' : 'desc';
    
    // Actualizar iconos
    table.querySelectorAll('.sortable i').forEach(icon => {
        icon.className = 'fas fa-sort';
    });
    
    const currentIcon = table.querySelector(`[data-column="${column}"] i`);
    currentIcon.className = isAscending ? 'fas fa-sort-up' : 'fas fa-sort-down';
}

function getCellValue(row, column) {
    const columnIndex = Array.from(row.closest('table').querySelectorAll('th')).findIndex(th => th.dataset.column === column);
    return row.cells[columnIndex]?.textContent.trim() || '';
}
</script>
{% endblock %}
