{% extends "base.html" %}

{% block title %}Cambiar Contraseña - Gestión de Taller{% endblock %}

{% block content %}
<div class="page-header">
    <h1><i class="fas fa-key"></i> Cambiar Contraseña</h1>
    <nav aria-label="breadcrumb">
        <ol class="breadcrumb">
            <li class="breadcrumb-item"><a href="{{ url_for('index') }}">Inicio</a></li>
            <li class="breadcrumb-item active">Cambiar Contraseña</li>
        </ol>
    </nav>
</div>

<div class="row justify-content-center">
    <div class="col-md-6 col-lg-5">
        <div class="card">
            <div class="card-header">
                <h5 class="mb-0">
                    <i class="fas fa-shield-alt me-2"></i>
                    Actualizar Contraseña
                </h5>
            </div>
            <div class="card-body">
                <div class="alert alert-info mb-4">
                    <div class="d-flex">
                        <i class="fas fa-info-circle me-2 mt-1"></i>
                        <div>
                            <strong>Recomendaciones de seguridad:</strong>
                            <ul class="mb-0 mt-2">
                                <li>Usa al menos 8 caracteres</li>
                                <li>Combina letras, números y símbolos</li>
                                <li>Evita información personal</li>
                                <li>No reutilices contraseñas antiguas</li>
                            </ul>
                        </div>
                    </div>
                </div>

                <form method="POST" id="changePasswordForm">
                    <div class="mb-3">
                        <label for="password_actual" class="form-label">
                            <i class="fas fa-lock me-2"></i>Contraseña Actual
                        </label>
                        <div class="input-group">
                            <input type="password" class="form-control" id="password_actual" name="password_actual" required>
                            <button class="btn btn-outline-secondary" type="button" id="toggleCurrentPassword">
                                <i class="fas fa-eye"></i>
                            </button>
                        </div>
                        <div class="form-text">Ingresa tu contraseña actual para confirmar tu identidad</div>
                    </div>

                    <div class="mb-3">
                        <label for="password_nueva" class="form-label">
                            <i class="fas fa-key me-2"></i>Nueva Contraseña
                        </label>
                        <div class="input-group">
                            <input type="password" class="form-control" id="password_nueva" name="password_nueva" required minlength="6">
                            <button class="btn btn-outline-secondary" type="button" id="toggleNewPassword">
                                <i class="fas fa-eye"></i>
                            </button>
                        </div>
                        <div class="password-strength mt-2">
                            <div class="progress" style="height: 5px;">
                                <div class="progress-bar" id="strengthBar" role="progressbar" style="width: 0%"></div>
                            </div>
                            <small class="form-text" id="strengthText">Ingresa una contraseña</small>
                        </div>
                    </div>

                    <div class="mb-4">
                        <label for="password_confirmar" class="form-label">
                            <i class="fas fa-check-double me-2"></i>Confirmar Nueva Contraseña
                        </label>
                        <div class="input-group">
                            <input type="password" class="form-control" id="password_confirmar" name="password_confirmar" required minlength="6">
                            <button class="btn btn-outline-secondary" type="button" id="toggleConfirmPassword">
                                <i class="fas fa-eye"></i>
                            </button>
                        </div>
                        <div class="form-text" id="confirmText">Repite la nueva contraseña</div>
                    </div>

                    <div class="d-grid gap-2 d-md-flex justify-content-md-end">
                        <a href="{{ url_for('index') }}" class="btn btn-secondary me-md-2">
                            <i class="fas fa-times me-2"></i>Cancelar
                        </a>
                        <button type="submit" class="btn btn-primary" id="submitBtn">
                            <i class="fas fa-save me-2"></i>Cambiar Contraseña
                        </button>
                    </div>
                </form>
            </div>
        </div>

        <!-- Panel de información de seguridad -->
        <div class="card mt-4">
            <div class="card-header">
                <h6 class="mb-0">
                    <i class="fas fa-info-circle me-2"></i>
                    Información de Sesión
                </h6>
            </div>
            <div class="card-body">
                <div class="row g-3">
                    <div class="col-md-6">
                        <div class="d-flex align-items-center">
                            <i class="fas fa-user text-primary me-2"></i>
                            <div>
                                <small class="text-muted">Usuario:</small>
                                <div class="fw-bold">{{ session.username }}</div>
                            </div>
                        </div>
                    </div>
                    <div class="col-md-6">
                        <div class="d-flex align-items-center">
                            <i class="fas fa-user-tag text-success me-2"></i>
                            <div>
                                <small class="text-muted">Rol:</small>
                                <div class="fw-bold text-capitalize">{{ session.user_role }}</div>
                            </div>
                        </div>
                    </div>
                    <div class="col-12">
                        <div class="d-flex align-items-center">
                            <i class="fas fa-clock text-info me-2"></i>
                            <div>
                                <small class="text-muted">Último acceso:</small>
                                <div class="fw-bold" id="lastAccess">Calculando...</div>
                            </div>
                        </div>
                    </div>
                </div>
                
                <div class="mt-3 pt-3 border-top">
                    <div class="text-center">
                        <a href="{{ url_for('logout') }}" class="btn btn-outline-danger btn-sm">
                            <i class="fas fa-sign-out-alt me-2"></i>Cerrar Todas las Sesiones
                        </a>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
document.addEventListener('DOMContentLoaded', function() {
    // Elementos del formulario
    const form = document.getElementById('changePasswordForm');
    const currentPassword = document.getElementById('password_actual');
    const newPassword = document.getElementById('password_nueva');
    const confirmPassword = document.getElementById('password_confirmar');
    const submitBtn = document.getElementById('submitBtn');
    const strengthBar = document.getElementById('strengthBar');
    const strengthText = document.getElementById('strengthText');
    const confirmText = document.getElementById('confirmText');

    // Toggles para mostrar/ocultar contraseñas
    setupPasswordToggle('toggleCurrentPassword', 'password_actual');
    setupPasswordToggle('toggleNewPassword', 'password_nueva');
    setupPasswordToggle('toggleConfirmPassword', 'password_confirmar');

    // Verificador de fortaleza de contraseña
    newPassword.addEventListener('input', function() {
        const password = this.value;
        const strength = calculatePasswordStrength(password);
        updateStrengthIndicator(strength);
        validatePasswordMatch();
    });

    // Verificador de coincidencia de contraseñas
    confirmPassword.addEventListener('input', validatePasswordMatch);

    // Validación del formulario
    form.addEventListener('submit', function(e) {
        if (!validateForm()) {
            e.preventDefault();
            return false;
        }
        
        // Mostrar loading
        submitBtn.innerHTML = '<span class="loading-spinner me-2"></span>Cambiando...';
        submitBtn.disabled = true;
    });

    function setupPasswordToggle(buttonId, inputId) {
        const button = document.getElementById(buttonId);
        const input = document.getElementById(inputId);
        
        button.addEventListener('click', function() {
            const type = input.getAttribute('type') === 'password' ? 'text' : 'password';
            input.setAttribute('type', type);
            
            const icon = this.querySelector('i');
            icon.classList.toggle('fa-eye');
            icon.classList.toggle('fa-eye-slash');
        });
    }

    function calculatePasswordStrength(password) {
        let score = 0;
        let feedback = [];

        if (password.length === 0) {
            return { score: 0, feedback: ['Ingresa una contraseña'], level: 'none' };
        }

        // Longitud
        if (password.length >= 8) score += 25;
        else feedback.push('Al menos 8 caracteres');

        // Letras minúsculas
        if (/[a-z]/.test(password)) score += 25;
        else feedback.push('Incluye letras minúsculas');

        // Letras mayúsculas
        if (/[A-Z]/.test(password)) score += 25;
        else feedback.push('Incluye letras mayúsculas');

        // Números
        if (/\d/.test(password)) score += 15;
        else feedback.push('Incluye números');

        // Símbolos
        if (/[^A-Za-z0-9]/.test(password)) score += 10;
        else feedback.push('Incluye símbolos');

        // Bonificaciones
        if (password.length >= 12) score += 10;
        if (/(?=.*[a-z])(?=.*[A-Z])(?=.*\d)(?=.*[^A-Za-z0-9])/.test(password)) score += 10;

        let level, className;
        if (score < 30) {
            level = 'Muy débil';
            className = 'bg-danger';
        } else if (score < 60) {
            level = 'Débil';
            className = 'bg-warning';
        } else if (score < 80) {
            level = 'Buena';
            className = 'bg-info';
        } else {
            level = 'Excelente';
            className = 'bg-success';
        }

        return { score, feedback, level, className };
    }

    function updateStrengthIndicator(strength) {
        strengthBar.style.width = strength.score + '%';
        strengthBar.className = 'progress-bar ' + (strength.className || '');
        
        if (strength.score === 0) {
            strengthText.textContent = 'Ingresa una contraseña';
            strengthText.className = 'form-text text-muted';
        } else {
            strengthText.textContent = `Fortaleza: ${strength.level}`;
            strengthText.className = 'form-text text-' + 
                (strength.className === 'bg-danger' ? 'danger' :
                 strength.className === 'bg-warning' ? 'warning' :
                 strength.className === 'bg-info' ? 'info' : 'success');
        }
    }

    function validatePasswordMatch() {
        const newPass = newPassword.value;
        const confirmPass = confirmPassword.value;
        
        if (confirmPass.length === 0) {
            confirmText.textContent = 'Repite la nueva contraseña';
            confirmText.className = 'form-text text-muted';
            confirmPassword.classList.remove('is-valid', 'is-invalid');
            return;
        }
        
        if (newPass === confirmPass) {
            confirmText.textContent = 'Las contraseñas coinciden';
            confirmText.className = 'form-text text-success';
            confirmPassword.classList.remove('is-invalid');
            confirmPassword.classList.add('is-valid');
        } else {
            confirmText.textContent = 'Las contraseñas no coinciden';
            confirmText.className = 'form-text text-danger';
            confirmPassword.classList.remove('is-valid');
            confirmPassword.classList.add('is-invalid');
        }
    }

    function validateForm() {
        const currentPass = currentPassword.value;
        const newPass = newPassword.value;
        const confirmPass = confirmPassword.value;

        if (!currentPass || !newPass || !confirmPass) {
            window.notificationSystem?.error('Completa todos los campos');
            return false;
        }

        if (newPass.length < 6) {
            window.notificationSystem?.error('La nueva contraseña debe tener al menos 6 caracteres');
            return false;
        }

        if (newPass !== confirmPass) {
            window.notificationSystem?.error('Las contraseñas nuevas no coinciden');
            return false;
        }

        if (currentPass === newPass) {
            window.notificationSystem?.warning('La nueva contraseña debe ser diferente a la actual');
            return false;
        }

        return true;
    }

    // Mostrar último acceso (simulado)
    setTimeout(() => {
        const lastAccessElement = document.getElementById('lastAccess');
        const now = new Date();
        lastAccessElement.textContent = now.toLocaleString('es-ES', {
            year: 'numeric',
            month: 'long',
            day: 'numeric',
            hour: '2-digit',
            minute: '2-digit'
        });
    }, 500);

    // Auto-focus en contraseña actual
    currentPassword.focus();
});
</script>
{% endblock %}
